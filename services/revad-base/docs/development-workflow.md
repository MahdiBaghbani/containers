# Development → Production Workflow

This document describes the workflow for using development images to generate configurations and production images to run services.

## Overview

The `revad-base` service uses a two-stage workflow:

1. **Development Images**: Process configuration templates → write to volumes
2. **Production Images**: Read pre-processed configs from volumes (no processing)

## Development Images

### Purpose

Development images contain:

- Reva binary
- Configuration templates (with placeholders)
- Initialization scripts (Nushell)
- Runtime tools (nushell, bash, etc.)

### Behavior

When a development container starts:

1. **Entrypoint**: `entrypoint.sh` → `entrypoint-init.nu`
2. **Initialization**: Scripts process configs:
   - Copy templates from `/configs/revad` (image) → `/etc/revad` (volume)
   - Process placeholders using environment variables
   - Write processed configs to `/etc/revad` (volume)
3. **Service Start**: Start Reva daemon with processed config
4. **Container**: Continues running (via `tail -F /var/log/revad.log`)

### Volume Mounting

Development containers mount volumes for config output:

```yaml
volumes:
  - "${PWD}/volumes/config/reva-gateway:/etc/revad"
```

**First Run:**

- Volume is empty
- Scripts copy templates from image → volume
- Scripts process placeholders → write processed configs to volume

**Subsequent Runs:**

- Volume contains processed configs
- Scripts skip copy (configs exist)
- Scripts process placeholders (updates env var changes)
- Writes updated configs to volume

**User Edits:**

- Users can manually edit configs in volume
- Scripts preserve edits (skip copy if exists)
- Scripts still process placeholders (updates values)

## Production Images

### Purpose

Production images contain:

- Reva binary (compressed, optimized)
- No configuration templates
- No initialization scripts
- Minimal runtime (distroless/nonroot)

### Behavior

When a production container starts:

1. **Entrypoint**: Direct `revad` command
2. **No Processing**: No scripts, no placeholder processing
3. **Read Configs**: Reads configs from `/etc/revad` (volume)
4. **Service Start**: Starts Reva daemon with pre-processed configs

### Volume Mounting

Production containers mount the same volumes:

```yaml
volumes:
  - "${PWD}/volumes/config/reva-gateway:/etc/revad"
```

**Requirement:**

- Volume must contain pre-processed configs
- Configs must be generated by development containers first

## Workflow Steps

### Step 1: Build Development Images

Build development images with configs and scripts:

```bash
make build SERVICE=revad-base
# Or platform-specific:
make build SERVICE=cernbox-revad
```

### Step 2: Run Development Containers (First Time)

Run development containers to populate volumes:

```bash
docker-compose up -d
```

Development containers:

- Process config templates
- Write processed configs to volumes
- Start services

### Step 3: Verify Configs

Check that configs were processed correctly:

```bash
docker-compose exec gateway cat /etc/revad/gateway.toml
# Should show processed config (no placeholders)
```

### Step 4: Build Production Images

Build production images (no configs, no scripts):

```bash
make build SERVICE=revad-base
# Production images are built separately
```

### Step 5: Switch to Production Images

Update docker-compose to use production images:

```yaml
services:
  gateway:
    image: "revad-base:v3.3.2-production" # Production image
    # Same volumes (configs already populated)
    volumes:
      - "${PWD}/volumes/config/reva-gateway:/etc/revad"
```

### Step 6: Run Production Containers

Production containers read from volumes:

```bash
docker-compose up -d
```

Production containers:

- Read pre-processed configs from volumes
- Start services directly (no processing)

## Volume Persistence

Volumes persist between container runs:

- **Development → Development**: Configs persist, scripts update placeholders
- **Development → Production**: Configs persist, production reads them
- **Production → Production**: Configs persist, production reads them

## First-Run Requirement

**Critical**: Production containers require volumes to be pre-populated.

**Options:**

1. **Run development containers first** (recommended):

   - Development containers populate volumes
   - Switch to production images
   - Production containers read from volumes

2. **Pre-populate volumes manually**:

   - Copy processed configs to volume directories
   - Run production containers directly

3. **Use development images in production** (not recommended):
   - Development images work but include unnecessary tools
   - Production images are smaller and more secure

## Configuration Updates

### Updating Environment Variables

To update configuration:

1. **Update environment variables** in docker-compose or env file
2. **Restart development containers**:

   ```bash
   docker-compose restart gateway
   ```

3. **Scripts process placeholders** → update configs in volume
4. **Switch to production** (if using production images)

### Manual Configuration Edits

Users can edit configs directly in volumes:

1. **Edit config file** in volume directory:

   ```bash
   vi volumes/config/reva-gateway/gateway.toml
   ```

2. **Restart container**:

   ```bash
   docker-compose restart gateway
   ```

3. **Scripts preserve edits** (skip copy if exists)
4. **Scripts still process placeholders** (updates values)

## Related Documentation

- [Initialization](initialization.md) - Initialization process details
- [Configuration](configuration.md) - Configuration and placeholder system
- [Container Modes](container-modes.md) - Container mode system
