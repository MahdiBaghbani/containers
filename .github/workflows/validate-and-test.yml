# SPDX-License-Identifier: AGPL-3.0-or-later
# Reusable CI engine workflow for validation and testing
# Called by ci-pr.yml, cd-master-manual.yml, ci-master-scheduled.yml
#
# Note: dockypody.nu is the canonical CLI entrypoint
# Local equivalent: nu -c "use scripts/dockypody.nu; dockypody test --suite all"

name: Validate and Test

on:
  workflow_call:
    inputs:
      verbose:
        description: "Enable verbose output"
        required: false
        type: boolean
        default: false

jobs:
  validate-and-test:
    name: Validate and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nushell
        env:
          NU_VERSION: "0.108.0"
        run: |
          curl -fsSL -o /tmp/nu.tar.gz \
            "https://github.com/nushell/nushell/releases/download/${NU_VERSION}/nu-${NU_VERSION}-x86_64-unknown-linux-gnu.tar.gz"
          mkdir -p /tmp/nu
          tar -xzf /tmp/nu.tar.gz -C /tmp/nu --strip-components=1
          sudo mv /tmp/nu/nu /usr/local/bin/nu
          nu --version

      - name: Validate schema example files
        run: |
          echo "Validating schema example files..."
          failed=0
          for example in schemas/examples/*.nuon; do
            if [ -f "$example" ]; then
              echo "Validating: $example"
              if ! nu -c "open '$example'" > /dev/null 2>&1; then
                echo "ERROR: Failed to parse $example"
                failed=1
              fi
            fi
          done
          if [ $failed -eq 1 ]; then
            echo "Schema example validation failed"
            exit 1
          fi
          echo "All schema examples validated successfully"

      - name: Check for outdated schema references
        run: |
          echo "Checking for outdated schema file references in documentation..."
          errors=0
          if grep -r "service-config\.nuon" docs/ 2>/dev/null; then
            echo "ERROR: Found reference to old schema name 'service-config.nuon'"
            errors=1
          fi
          if grep -r "version-manifest\.nuon" docs/ 2>/dev/null; then
            echo "ERROR: Found reference to old schema name 'version-manifest.nuon'"
            errors=1
          fi
          if [ $errors -eq 1 ]; then
            echo "Outdated schema references found"
            exit 1
          fi
          echo "No outdated schema references found"

      - name: Run top-level test suite
        run: |
          echo "Running top-level test suite (all suites)..."
          nu scripts/dockypody.nu test --suite all

      - name: Run service-level tests
        run: |
          echo "Discovering and running service-level tests..."
          failed_services=()
          tested_services=()
          
          # Find all service test runners
          for runner in services/*/tests/test-runner.nu; do
            if [ -f "$runner" ]; then
              # Extract service name from path: services/<name>/tests/test-runner.nu
              service=$(echo "$runner" | cut -d'/' -f2)
              echo ""
              echo "========================================"
              echo "Running tests for service: $service"
              echo "========================================"
              
              if nu "$runner"; then
                echo "PASSED: $service"
                tested_services+=("$service")
              else
                echo "FAILED: $service"
                failed_services+=("$service")
                tested_services+=("$service")
              fi
            fi
          done
          
          echo ""
          echo "========================================"
          echo "Service Test Summary"
          echo "========================================"
          echo "Services tested: ${#tested_services[@]}"
          
          if [ ${#tested_services[@]} -eq 0 ]; then
            echo "No service-level tests found (this is OK)"
            exit 0
          fi
          
          echo "Tested: ${tested_services[*]}"
          
          if [ ${#failed_services[@]} -gt 0 ]; then
            echo ""
            echo "FAILED services: ${failed_services[*]}"
            echo ""
            echo "${#failed_services[@]} service test suite(s) failed"
            exit 1
          fi
          
          echo ""
          echo "All service tests passed"
