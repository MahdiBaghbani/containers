# SPDX-License-Identifier: AGPL-3.0-or-later
# DockyPody: container build scripts and images
# Copyright (C) 2025 Mahdi Baghbani <mahdi-baghbani@azadehafzar.io>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# Reusable workflow for building a single service using a dynamic version+platform matrix
#
# GENERATED FILE - Do not edit manually
# Regenerate with: nu scripts/dockypody.nu ci workflow --target build-service

name: Build Service

on:
  workflow_call:
    inputs:
      service:
        description: "Service name to build"
        required: true
        type: string
      push:
        description: "Push images to registry"
        required: false
        type: boolean
        default: false
      dependencies:
        description: "Comma-separated list of dependency service names for artifact loading"
        required: false
        type: string
        default: ""
      disk_monitor_mode:
        description: "Disk monitoring mode: off, basic"
        required: false
        type: string
        default: "off"
      prune_build_cache:
        description: "Enable pruning of BuildKit cache mounts"
        required: false
        type: boolean
        default: true


jobs:
  setup:
    name: Setup matrix for ${{ inputs.service }}
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nushell
        env:
          NU_VERSION: 0.108.0
        run: |
          curl -fsSL -o /tmp/nu.tar.gz "https://github.com/nushell/nushell/releases/download/${{ env.NU_VERSION }}/nu-${{ env.NU_VERSION }}-x86_64-unknown-linux-gnu.tar.gz"
          mkdir -p /tmp/nu
          tar -xzf /tmp/nu.tar.gz -C /tmp/nu --strip-components=1
          sudo mv /tmp/nu/nu /usr/local/bin/nu
          nu --version

      - name: Generate service matrix
        id: matrix
        run: |
          MATRIX_JSON=$(nu -c "use scripts/lib/build/matrix.nu [generate-service-matrix]; generate-service-matrix '${{ inputs.service }}' --include-metadata=false | to json -r")
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "Generated matrix for ${{ inputs.service }}:"
          echo "$MATRIX_JSON" | jq .

  build:
    name: v${{ matrix.version }}${{ matrix.platform != '' && format('-{0}', matrix.platform) || '' }}
    needs: [setup]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nushell
        env:
          NU_VERSION: 0.108.0
        run: |
          curl -fsSL -o /tmp/nu.tar.gz "https://github.com/nushell/nushell/releases/download/${{ env.NU_VERSION }}/nu-${{ env.NU_VERSION }}-x86_64-unknown-linux-gnu.tar.gz"
          mkdir -p /tmp/nu
          tar -xzf /tmp/nu.tar.gz -C /tmp/nu --strip-components=1
          sudo mv /tmp/nu/nu /usr/local/bin/nu
          nu --version

      - name: Install zstd
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y zstd

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker

      - name: Prepare dependency shards
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: nu scripts/dockypody.nu ci prepare-node-deps --service ${{ inputs.service }} --version ${{ matrix.version }} --platform "${{ matrix.platform }}" --dependencies "${{ inputs.dependencies }}"

      - name: Build node
        run: |
          PLATFORM_FLAG=""
          if [ -n "${{ matrix.platform }}" ]; then
            PLATFORM_FLAG="--platform ${{ matrix.platform }}"
          fi
          nu scripts/dockypody.nu build \
            --service ${{ inputs.service }} \
            --version ${{ matrix.version }} \
            $PLATFORM_FLAG \
            --dep-cache=soft \
            --pull=deps,externals \
            --disk-monitor=${{ inputs.disk_monitor_mode }} \
            ${{ inputs.prune_build_cache && '--prune-cache-mounts' || '' }} \
            ${{ inputs.push && '--push' || '' }}

      - name: Create cache shard
        env:
          SHARD_ROOT: /tmp/docker-images/shards
        run: nu -c "use scripts/lib/ci/cache-shards.nu [create-node-shard]; create-node-shard '${{ inputs.service }}' '${{ matrix.version }}' '$SHARD_ROOT/${{ inputs.service }}' '${{ matrix.platform }}'"

      - name: Upload shard artifact
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ inputs.service }}-${{ matrix.version }}-${{ matrix.platform != '' && matrix.platform || 'single' }}
          path: /tmp/docker-images/shards/${{ inputs.service }}/
          retention-days: 1
          if-no-files-found: error
