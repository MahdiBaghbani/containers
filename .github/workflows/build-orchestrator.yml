# SPDX-License-Identifier: AGPL-3.0-or-later
# DockyPody: container build scripts and images
# Copyright (C) 2025 Mahdi Baghbani <mahdi-baghbani@azadehafzar.io>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# Reusable workflow for orchestrating service builds
#
# GENERATED FILE - Do not edit manually
# Regenerate with: nu scripts/dockypody.nu ci workflow --target orchestrator

name: Build Orchestrator

on:
  workflow_call:
    inputs:
      push:
        description: "Push images to registry"
        required: false
        type: boolean
        default: false

# Service dependency graph:
#
#   cernbox-revad - depends on: common-tools, gaia, revad-base
#   cernbox-web - depends on: common-tools
#   common-tools - (root service)
#   gaia - depends on: common-tools
#   idp - depends on: common-tools
#   nextcloud - depends on: nextcloud-base
#   nextcloud-base - depends on: common-tools
#   nextcloud-contacts - depends on: common-tools, nextcloud
#   revad-base - depends on: common-tools
#

jobs:
  build_cernbox_revad:
    name: cernbox-revad
    needs:
      - build_common_tools
      - build_gaia
      - build_revad_base
    uses: ./.github/workflows/build-service.yml
    with:
      service: cernbox-revad
      push: ${{ inputs.push }}
      dependencies: "revad-base,gaia,common-tools"
      disk_monitor_mode: basic
      prune_build_cache: true

  build_cernbox_web:
    name: cernbox-web
    needs:
      - build_common_tools
    uses: ./.github/workflows/build-service.yml
    with:
      service: cernbox-web
      push: ${{ inputs.push }}
      dependencies: "common-tools"
      disk_monitor_mode: basic
      prune_build_cache: true

  build_common_tools:
    name: common-tools
    uses: ./.github/workflows/build-service.yml
    with:
      service: common-tools
      push: ${{ inputs.push }}
      dependencies: ""
      disk_monitor_mode: basic
      prune_build_cache: true

  build_gaia:
    name: gaia
    needs:
      - build_common_tools
    uses: ./.github/workflows/build-service.yml
    with:
      service: gaia
      push: ${{ inputs.push }}
      dependencies: "common-tools"
      disk_monitor_mode: basic
      prune_build_cache: true

  build_idp:
    name: idp
    needs:
      - build_common_tools
    uses: ./.github/workflows/build-service.yml
    with:
      service: idp
      push: ${{ inputs.push }}
      dependencies: "common-tools"
      disk_monitor_mode: basic
      prune_build_cache: true

  build_nextcloud:
    name: nextcloud
    needs:
      - build_nextcloud_base
    uses: ./.github/workflows/build-service.yml
    with:
      service: nextcloud
      push: ${{ inputs.push }}
      dependencies: "common-tools,nextcloud-base"
      disk_monitor_mode: basic
      prune_build_cache: true

  build_nextcloud_base:
    name: nextcloud-base
    needs:
      - build_common_tools
    uses: ./.github/workflows/build-service.yml
    with:
      service: nextcloud-base
      push: ${{ inputs.push }}
      dependencies: "common-tools"
      disk_monitor_mode: basic
      prune_build_cache: true

  build_nextcloud_contacts:
    name: nextcloud-contacts
    needs:
      - build_common_tools
      - build_nextcloud
    uses: ./.github/workflows/build-service.yml
    with:
      service: nextcloud-contacts
      push: ${{ inputs.push }}
      dependencies: "nextcloud-base,nextcloud,common-tools"
      disk_monitor_mode: basic
      prune_build_cache: true

  build_revad_base:
    name: revad-base
    needs:
      - build_common_tools
    uses: ./.github/workflows/build-service.yml
    with:
      service: revad-base
      push: ${{ inputs.push }}
      dependencies: "common-tools"
      disk_monitor_mode: basic
      prune_build_cache: true

  build_complete:
    name: Build Complete
    needs:
      - build_cernbox_revad
      - build_cernbox_web
      - build_common_tools
      - build_gaia
      - build_idp
      - build_nextcloud
      - build_nextcloud_base
      - build_nextcloud_contacts
      - build_revad_base
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Clean up shard artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: shard-*
          failOnError: false

      - name: All builds completed
        run: echo "Build orchestration finished"
